---
title: "Final Transmission"
date: 2025-11-07 18:30:00 +0000
categories: [Writeups, Forensics, Spooky CTF 2025]
tags: [forensics, writeup]
description: Spooky CTF 2025 - Final Transmission Writeup
---

### Description

A corrupted transmission has been recovered from a dying network node. Your task is to extract and analyze the recovered disk image to uncover what Helios Ark tried to preserve. Somwehere inside lies the truth of this world.

### Handout

- final_transmission.pcap
- client.txt
- server.txt
- sslkeys.log

### Solve

```sh
shieda@pop-os:~/Desktop/CTFs/spookyctf2025/final-transmission$ cat client.txt 
src 10.0.0.3 dst 10.0.0.2
	proto esp spi 0x00000101 reqid 0 mode transport
	replay-window 0 
	auth-trunc hmac(sha256) 0x31313232333334343535363637373838393930306161626263636464656566663030313132323333343435353636373738383939616162626363646465656666 96
	enc cbc(aes) 0x3030313132323333343435353636373738383939616162626363646465656666
	lastused 2025-10-12 17:06:40
	anti-replay context: seq 0x0, oseq 0x0, bitmap 0x00000000
	sel src 0.0.0.0/0 dst 0.0.0.0/0 
src 10.0.0.2 dst 10.0.0.3
	proto esp spi 0x00000100 reqid 0 mode transport
	replay-window 0 
	auth-trunc hmac(sha256) 0x31313232333334343535363637373838393930306161626263636464656566663030313132323333343435353636373738383939616162626363646465656666 96
	enc cbc(aes) 0x3030313132323333343435353636373738383939616162626363646465656666
	lastused 2025-10-12 17:06:40
	anti-replay context: seq 0x0, oseq 0x13c, bitmap 0x00000000
	sel src 0.0.0.0/0 dst 0.0.0.0/0 
```

```sh
shieda@pop-os:~/Desktop/CTFs/spookyctf2025/final-transmission$ cat server.txt 
src 10.0.0.2 dst 10.0.0.3
	proto esp spi 0x00000100 reqid 0 mode transport
	replay-window 0 
	auth-trunc hmac(sha256) 0x31313232333334343535363637373838393930306161626263636464656566663030313132323333343435353636373738383939616162626363646465656666 96
	enc cbc(aes) 0x3030313132323333343435353636373738383939616162626363646465656666
	lastused 2025-10-12 17:06:40
	anti-replay context: seq 0x0, oseq 0x0, bitmap 0x00000000
	sel src 0.0.0.0/0 dst 0.0.0.0/0 
src 10.0.0.3 dst 10.0.0.2
	proto esp spi 0x00000101 reqid 0 mode transport
	replay-window 0 
	auth-trunc hmac(sha256) 0x31313232333334343535363637373838393930306161626263636464656566663030313132323333343435353636373738383939616162626363646465656666 96
	enc cbc(aes) 0x3030313132323333343435353636373738383939616162626363646465656666
	lastused 2025-10-12 17:06:40
	anti-replay context: seq 0x0, oseq 0x389, bitmap 0x00000000
	sel src 0.0.0.0/0 dst 0.0.0.0/0 
```

```sh
shieda@pop-os:~/Desktop/CTFs/spookyctf2025/final-transmission$ cat sslkeys.log 
# TLS secrets log file, generated by OpenSSL / Python
SERVER_HANDSHAKE_TRAFFIC_SECRET 204d0530cdf1d77b7eb2fb7dd7ed9a270103ca35d260ad1c5024d02dfcd8db4c 8613926ddf6ca3aeb59b76cf398033e36e3995338f9e0f4d877af4dcec001c960853e79a63c1ed350208e6c9c08bba42
EXPORTER_SECRET 204d0530cdf1d77b7eb2fb7dd7ed9a270103ca35d260ad1c5024d02dfcd8db4c c410773045c320f177f51f7876da6bbed4065297cc6e6665b778991a04e506871cf68fe7d0cc57714964b5979e5630a8
SERVER_TRAFFIC_SECRET_0 204d0530cdf1d77b7eb2fb7dd7ed9a270103ca35d260ad1c5024d02dfcd8db4c ad2c6a7207229ab9bef233d9dda4b253ec8e3af91605912889c929eb695770bb0ae481f4693d52b85962a212a8173a9f
CLIENT_HANDSHAKE_TRAFFIC_SECRET 204d0530cdf1d77b7eb2fb7dd7ed9a270103ca35d260ad1c5024d02dfcd8db4c dff76502812fcff9fba013ed71d07132ab4ed696025efe29d1f1a39129d742d6970d386e94d37e638a204b2b9e3a34e4
CLIENT_TRAFFIC_SECRET_0 204d0530cdf1d77b7eb2fb7dd7ed9a270103ca35d260ad1c5024d02dfcd8db4c 23646a4b040293d868ea010d49b83afe65e26f284fcd320c974ebccde3339243e2fbb908664bc3e573c184ac00dbdc9a
SERVER_HANDSHAKE_TRAFFIC_SECRET 68bf9e08b499edbb9a8032c95a7c512b8e2639b707447cba3ede8da54bf09205 de98fcbb88ce873173179893bd4a054ea1af14771e9a5bd05a61c23e52e2943dea20cbfb1516dcc8f49334ae9e722ec7
EXPORTER_SECRET 68bf9e08b499edbb9a8032c95a7c512b8e2639b707447cba3ede8da54bf09205 875785672569dca543ab32dc3b94061d1ae9a7c1b5d6be625149871cd734ab2b97d03472210fdc28be009a5f090da9ac
SERVER_TRAFFIC_SECRET_0 68bf9e08b499edbb9a8032c95a7c512b8e2639b707447cba3ede8da54bf09205 998dae629e20544e430b7cfb8d0ad3828f446a713437b0e64b1a25ac700c00756f035654dad5e01dbc4247bce0b0b582
CLIENT_HANDSHAKE_TRAFFIC_SECRET 68bf9e08b499edbb9a8032c95a7c512b8e2639b707447cba3ede8da54bf09205 d4b27f6d7bc96fcee3a45d6164950a7be1ec0504d0ac98377ebe4f6ae5c3e8e5483d729b4bc83fa51faec643c0507a1c
CLIENT_TRAFFIC_SECRET_0 68bf9e08b499edbb9a8032c95a7c512b8e2639b707447cba3ede8da54bf09205 392bef7e85c21ca8768c99df90d08b561872771e2e60063f2099f7c0b4de0bfffb35ac52c5237c6efa7dd76a2fd0ffdb
```

By opening the .pcap file in wireshark we can see **ESP** traffic exchanged between `10.0.0.2` and `10.0.0.3`.

**ESP (Encapsulating Security Payload)** is a protocol in the IPsec suite that provides data confidentiality, origin authentication, integrity, and replay protection for IP packets. It achieves this by encrypting the data payload and adding an ESP header and trailer to create a secure tunnel for data transmission.

The `client.txt` and `server.txt` files provide all the information needed to decrypt the packets exchanged between both devices:

- Security Parameters Index (SPI)
- Encryption algorithm (cipher) 
- Encryption key (ESP encryption key)
- Integrity/authentication algorithm (if used)
- Initialization Vector

We can define these parameters in wireshark by navigating to: `Edit → Preferences → Protocols → ESP` and manually editing the values for each field.

![](assets/img/esp.png)

After correctly applying the ESP parameters and decrypting the packets we notice that there is another layer of encryption. This time the traffic is TLS encrypted. TLS packets can be decrypted by providing the SSL logs information, which we happen to have on the `sslkeys.log` file.

To do so, we navigate to `Edit → Preferences → Protocols → TLS` and point the (Pre)-Master-Secret log filename to our `sslkeys.log` full path.

![](assets/img/tls.png)

Now that we have the TLS decrypted data we can see exactly what is happening during the TLS session.

Following the first TLS stream we see the following **FTP control channel** messages:

```
USER bunkeruser
331 Please specify the password.
PASS BunkerP@ss!123
230 Login successful.
PBSZ 0
200 PBSZ set to 0.
PROT P
200 PROT now Private.
CWD ftp
250 Directory successfully changed.
TYPE I
200 Switching to Binary mode.
PASV
227 Entering Passive Mode (10,0,0,3,117,52).
RETR helios_archive.db
150 Opening BINARY mode data connection for helios_archive.db (491520 bytes).
226 Transfer complete.
QUIT
221 Goodbye.
```

After authentication, the server tells client to connect to IP 10.0.0.3 and port computed from the two last numbers: port = 117*256 + 52 = 30004. This is the data TCP connection where the actual file bytes will flow. The client then requests the server to send what appears to be a SQLite3 databse file (.db) before closing the connection.

We then look for the TCP stream with the file bytes and extract them. We can confirm that the stream is carrying a SQLite3 database file by looking at the magic bytes.

![](assets/img/sql.png)

After saving the raw bytes into a file we can use `sqlite3`to investigate.

We find two tables: `admin_log` and `uploads`.

In the `admin_log` table we can see the command used to decrypt the flag, including the password used: `helios-ark-finalkey-2049`.

The encrypted flag bytes sit on the `uploads` table. We just need to extract the bytes and use the same `openssl` command we found.

```sh
shieda@pop-os:~/Desktop/CTFs/spookyctf2025/final-transmission$ file file.db
file.db: SQLite 3.x database, last written using SQLite version 3045001, writer version 2, read version 2, file counter 2, database pages 120, cookie 0x2, schema 4, UTF-8, version-valid-for 2
```

```sql
SQLite version 3.37.2 2022-01-06 13:25:41
Enter ".help" for usage hints.
sqlite> .tables
admin_log  uploads  
sqlite> PRAGMA table_info(admin_log);
0|id|INTEGER|0||1
1|cmd|TEXT|0||0
sqlite> PRAGMA table_info(uploads);
0|id|INTEGER|0||1
1|name|TEXT|0||0
2|data|BLOB|0||0
sqlite> select * from admin_log;
1|openssl enc -d -aes-256-cbc -pbkdf2 -in /var/lib/helios/flag.txt.enc -out /tmp/flag.txt -pass pass:helios-ark-finalkey-2049
sqlite> select id, name from uploads;
1|helios_archive.tar.gz.enc
2|photo1.enc
3|photo2.enc
4|manifesto.txt.enc
5|flag.txt.enc
6|notes.txt
sqlite> select hex(data) from uploads where name='flag.txt.enc';
53616C7465645F5F6375DEF5DAD6A96A7C321D088AFCEB7931620C7772CDEADA0049DD695D6F3F5F43D7176AB2BEF047
sqlite> .exit
```

```sh
shieda@pop-os:~/Desktop/CTFs/spookyctf2025/final-transmission$ echo "53616C7465645F5F6375DEF5DAD6A96A7C321D088AFCEB7931620C7772CDEADA0049DD695D6F3F5F43D7176AB2BEF047" | xxd -r -p > flag.txt.enc
shieda@pop-os:~/Desktop/CTFs/spookyctf2025/final-transmission$ openssl enc -d -aes-256-cbc -pbkdf2 -in flag.txt.enc -out flag.txt -pass pass:helios-ark-finalkey-2049
shieda@pop-os:~/Desktop/CTFs/spookyctf2025/final-transmission$ cat flag.txt
NICC{ARK_SIG_7F3A1B}
```

And voilà, there is our flag: `NICC{ARK_SIG_7F3A1B}`


